name: Deploy to EC2

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Grant execute permission for Gradle wrapper
        run: chmod +x gradlew

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '21'

      - name: Build with Gradle
        run: ./gradlew clean bootJar -x test

      - name: Copy Jar to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: build/libs/*.jar
          target: /home/ubuntu/hooked-api/
          strip: 2

      - name: Execute Remote Commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Ensure deployment directory exists
            mkdir -p /home/ubuntu/hooked-api
            cd /home/ubuntu/hooked-api

            # Remove old JARs
            rm -f *.jar

            # Rename the new JAR to a consistent name
            if ls *.jar 1> /dev/null 2>&1; then
              mv *.jar hooked-api.jar
            fi

            # Start the application
            nohup java -jar hooked-api.jar --spring.profiles.active=production > hooked-api.log 2>&1 &
